<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Vendor Finder</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f4f7f6; padding: 20px; color: #333; }
        .search-container { max-width: 800px; margin: 0 auto 30px; display: flex; gap: 10px; flex-wrap: wrap; }
        input { flex: 2; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; min-width: 200px; }
        .btn-group { display: flex; gap: 8px; flex: 1; min-width: 200px; }
        
        button { flex: 1; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; transition: opacity 0.2s; }
        .btn-search { background: #007bff; color: white; }
        .btn-clear { background: #6c757d; color: white; }
        button:hover { opacity: 0.9; }
        
        .results-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; max-width: 1100px; margin: 0 auto; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.2s; position: relative; display: flex; flex-direction: column; min-height: 180px; }
        .card:hover { transform: translateY(-5px); }
        
        .confidence-badge { 
            position: absolute; top: 15px; right: 15px;
            background: #e3f2fd; color: #0d47a1; 
            font-size: 10px; padding: 4px 8px; border-radius: 12px; font-weight: bold;
        }

        .card h3 { margin: 10px 0 5px; font-size: 18px; color: #007bff; line-height: 1.3; padding-right: 70px; }
        .card p { font-size: 13px; margin: 4px 0; color: #666; }
        .rating { color: #f39c12; font-weight: bold; font-size: 14px; }
        
        .links { margin-top: auto; padding-top: 15px; display: flex; flex-wrap: wrap; gap: 8px; }
        .btn-link { text-decoration: none; font-size: 12px; padding: 8px 12px; border-radius: 6px; border: 1px solid #007bff; color: #007bff; font-weight: 500; }
        .btn-link:hover { background: #007bff; color: white; }
        
        .btn-whatsapp { border-color: #25D366; color: #25D366; }
        .btn-whatsapp:hover { background: #25D366; color: white; }
    </style>
</head>
<body>

    <h2 style="text-align: center;">AI Vendor Finder</h2>
    
    <div class="search-container">
        <input id="service" placeholder="Service (e.g. Pastries)" />
        <input id="location" placeholder="Location (e.g. Abuja)" />
        <div class="btn-group">
            <button class="btn-search" onclick="search()">Search</button>
            <button class="btn-clear" onclick="clearResults()">Clear</button>
        </div>
    </div>

    <div id="results" class="results-grid"></div>

    <script>
        function clearResults() {
            document.getElementById("service").value = "";
            document.getElementById("location").value = "";
            document.getElementById("results").innerHTML = "";
        }

        async function search() {
            const resultsDiv = document.getElementById("results");
            const service = document.getElementById("service").value;
            const location = document.getElementById("location").value;
            
            if(!service || !location) {
                alert("Please fill in both fields.");
                return;
            }

            resultsDiv.innerHTML = "<p style='grid-column: 1/-1; text-align:center;'>Searching for the best vendors...</p>";

            try {
                const res = await fetch(`/search?service=${encodeURIComponent(service)}&location=${encodeURIComponent(location)}`);
                const data = await res.json();
                resultsDiv.innerHTML = "";

                if (!data.vendors || data.vendors.length === 0) {
                    resultsDiv.innerHTML = "<p style='grid-column: 1/-1; text-align:center;'>No vendors found matching your criteria.</p>";
                    return;
                }

                data.vendors.forEach(vendor => {
                    // Clean Instagram Suffixes
                    const cleanName = (vendor.identity.name || "Vendor").split('(')[0].split('‚Ä¢')[0].trim();
                    const score = Math.round(vendor.confidence_score * 100);
                    const rating = vendor.location.google_maps?.rating ? `‚≠ê ${vendor.location.google_maps.rating}` : "New on Market";
                    
                    // Logic to find WhatsApp number
                    let whatsappNumber = null;
                    if (vendor.contacts && vendor.contacts.whatsapp && vendor.contacts.whatsapp.length > 0) {
                        whatsappNumber = vendor.contacts.whatsapp[0];
                    }

                    const cardHtml = `
                        <div class="card">
                            <span class="confidence-badge">${score}% Match</span>
                            <h3>${cleanName}</h3>
                            <p class="rating">${rating}</p>
                            <p>üìç ${vendor.location.google_maps?.address || vendor.location.text || "Location not specified"}</p>
                            
                            <div class="links">
                                <a href="${vendor.identity.url}" target="_blank" class="btn-link">Instagram</a>
                                ${vendor.location.google_maps?.place_id ? 
                                    `<a href="https://www.google.com/maps/search/?api=1&query=Google&query_place_id=${vendor.location.google_maps.place_id}" target="_blank" class="btn-link">Directions</a>` 
                                    : ""}
                                ${whatsappNumber ? 
                                    `<a href="https://wa.me/${whatsappNumber.replace(/\D/g,'')}" target="_blank" class="btn-link btn-whatsapp">WhatsApp</a>` 
                                    : ""}
                            </div>
                        </div>
                    `;
                    resultsDiv.innerHTML += cardHtml;
                });
            } catch (err) {
                resultsDiv.innerHTML = "<p style='grid-column: 1/-1; text-align:center; color:red;'>Error connecting to backend.</p>";
            }
        }
    </script>
</body>
</html>